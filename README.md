# 螺纹中缺陷和异物检测
## 介绍
这是一个课程设计项目，检测并定位螺纹超大图中的缺陷和异物。已有目标检测模型，此项目为获得模型后的工作。

在检修中，我们可能需要获得在两次检修中螺纹新增了什么缺陷，有没有异物新增或消失。每次检修都会使用相机拍摄内螺纹的图片进行拍摄，获得大图片。但人工对比很麻烦且耗时，能使用计算机快速检测具有很大的工程意义。

原本本项目想采用jittor训练模型进行目标检测，可惜没有成功，最后采用YOLOv8框架对模型进行训练。
## 使用方法
### 文件结构
1. **image_utils**是预处理图片的包文件夹，可调用，用法见其中。
2. **moban**是存放模板匹配小图片的文件夹。
### 环境
python环境3.9, 依赖包文件目录在requirements.txt中，请新建虚拟环境后安装，以方便包管理。
### 代码使用
1. **Single_image.py**是调用模型单独的图片，使用时需要在代码中修改图片文件和输出文件夹的位置
```bash
python Single_image.py
```
2. **two_imgs_duibi.py**是调用两张图片分别进行预处理（图像压缩、模板匹配、按比例切割重组），然后进行目标检测，再根据检测结果进行对比。
由于图像较大，采用512*512的滑动窗口进行检测，对于重叠的检测框会基于IoU判断重叠，且缺陷和异物需要单独的判断。最后会输出两张图片的对比信息。

新老图片进行对比时，会设置一个死区，两张图片的检测框在四区范围中波动时可以看作同一个缺陷或异物，两次检修中没有发生变化。
```bash
python two_imgs_duibi.py \
  --old ./old_image.bmp \  # 旧图片位置，必有
  --new ./new_image.bmp \  # 新图片位置，必有
  --model ./best.pt \      # 模型位置，必有
  --dead-zone 20 \         # 死区，可选，默认20
  --output ./results       # 输出文件夹，可选
```
### 未来改进
1. 由于每张图片首尾会有一定的像素重合，需要对不同的图片进行一定的裁减，且每一张图片裁减不同，需要对每张图片单独检测裁减像素。打算在*image_utils*中在添加新功能以便多次调用。
2. 两张图片对比效率还是太低了，可以添加并行检测功能（需要注意GPU显存大小），可以设计对新旧两次检修图片保存的文件夹进行统一的调用、检测、对比（文件夹中相同螺纹相同命名）。